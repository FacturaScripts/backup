{% extends "Master/MenuBghTemplate.html.twig" %}

{% block body %}
    <div class="bg-light pt-4 pb-5">
        <div class="container">
            <div class="row">
                <div class="col">
                    <h1 class="h4">
                        <i class="fa-solid fa-save fa-fw"></i> {{ fsc.title }}
                    </h1>
                    <br/>
                </div>
            </div>
        </div>
    </div>
    <div class="container" style="margin-top: -60px;">
        <div class="row">
            <div class="col">
                <form action="{{ fsc.url() }}" id="f_download" method="post">
                    {{ formToken() }}
                    <input type="hidden" name="action">
                    <input type="hidden" name="file_name">
                    <div class="card shadow mb-5">
                        <div class="card-body">
                            <h2 class="h3">
                                <i class="fa-solid fa-download text-primary mr-2"></i> {{ trans('download-backup') }}
                            </h2>
                            <p class="card-text">{{ trans('download-backup-p') }}</p>
                        </div>
                        <div class="card-footer p-2">
                            {% if fsc.db_file_name %}
                                <button type="button" class="btn btn-success btn-spin-action mr-2"
                                        onclick="downloadBackupAction('download-sql-file','{{ fsc.db_file_name }}')">
                                    <i class="fa-solid fa-download mr-2"></i> {{ trans('download') }}
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-primary btn-spin-action mr-2"
                                        onclick="createBackupAction('create-sql-file')">
                                    <i class="fa-solid fa-database mr-2"></i> {{ trans('database') }}
                                </button>
                            {% endif %}
                            {% if fsc.zip_file_name %}
                                <button type="button" class="btn btn-success btn-spin-action"
                                        onclick="downloadBackupAction('download-zip-file','{{ fsc.zip_file_name }}')">
                                    <i class="fa-solid fa-download mr-2"></i> {{ trans('download') }}
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-secondary btn-spin-action"
                                        onclick="createBackupAction('create-zip-file')">
                                    <i class="fa-solid fa-box-archive mr-2"></i> {{ trans('files') }}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </form>

                <form action="{{ fsc.url() }}" id="f_restore_db" method="post" enctype="multipart/form-data">
                    {{ formToken() }}
                    <input type="hidden" name="action" value="restore-backup"/>
                    <div class="card shadow mb-4">
                        <div class="card-body bg-warning">
                            <h3 class="h5 mb-0">
                                <i class="fa-solid fa-database mr-2"></i> {{ trans('restore-backup') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>
                                {{ trans('restore-backup-p') }}
                                <span class="text-danger">{{ trans('restore-backup-warning') }}</span>
                            </p>
                            <div class="form-group">
                                {{ trans('database') }}
                                <input type="file" name="db_file" accept=".sql,.sql.gz" class="form-control-file"
                                       required/>
                            </div>
                            <p class="card-text text-muted">
                                {{ trans('help-server-accepts-filesize', {'%size%': fsc.getMaxFileUpload()}) }}
                            </p>
                        </div>
                        <div class="card-footer p-2">
                            <button type="submit" class="btn btn-warning btn-spin-action">
                                {{ trans('restore') }}
                            </button>
                            <div class="btn-group ml-2">
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle btn-spin-action" type="button"
                                            data-toggle="dropdown" aria-expanded="false">
                                        {{ trans('switch-db-charset') }}
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item"
                                           href="?action=switch-db-charset&charset=utf8&multireqtoken={{ formToken(false) }}">
                                            utf8
                                        </a>
                                        <a class="dropdown-item"
                                           href="?action=switch-db-charset&charset=utf8mb4&multireqtoken={{ formToken(false) }}">
                                            utf8mb4
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <form action="{{ fsc.url() }}" id="f_restore_files" method="post" enctype="multipart/form-data">
                    {{ formToken() }}
                    <input type="hidden" name="action" value="restore-files"/>
                    <div class="card shadow mb-4">
                        <div class="card-body text-white bg-secondary">
                            <h3 class="h5 mb-0">
                                <i class="fa-solid fa-upload mr-2"></i> {{ trans('restore-files') }}
                            </h3>
                        </div>
                        <div class="card-body">
                            <p>{{ trans('restore-files-p') }}</p>
                            <div class="form-group">
                                {{ trans('files') }}
                                <input type="file" name="zip_file" accept=".zip" class="form-control-file" required/>
                            </div>
                            <p class="card-text text-muted">
                                {{ trans('help-server-accepts-filesize', {'%size%': fsc.getMaxFileUpload()}) }}
                            </p>
                        </div>
                        <div class="card-footer p-2">
                            <button type="submit" class="btn btn-warning btn-spin-action">
                                {{ trans('restore') }}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function createBackupAction(action) {
            animateSpinner('add');

            let form = $('#f_download');
            form.find('input[name="action"]').val(action);
            form.find('input[name="multireqtoken"]').val('{{ formToken(false) }}');
            form.submit();
        }

        function downloadBackupAction(action, file_name = '') {
            let form = $('#f_download');
            form.find('input[name="action"]').val(action);
            form.find('input[name="file_name"]').val(file_name);
            form.submit();
        }

        $(document).ready(function () {
            $('#f_restore_db').on('submit', function (e) {
                animateSpinner('add');
                let fileInput = $(this).find('input[type=file]');
                let fileSize = fileInput[0].files[0].size; // tamaño del archivo en bytes

                if (fileSize > {{ fsc.getMaxFileUpload() }} * 1024 * 1024) { // MB
                    e.preventDefault();
                    alert('{{ trans('backup-file-too-big', {'%size%': fsc.getMaxFileUpload()}) }}');
                    animateSpinner('remove');
                }
            });
            $('#f_restore_files').on('submit', function (e) {
                animateSpinner('add');
                let fileInput = $(this).find('input[type=file]');
                let fileSize = fileInput[0].files[0].size; // tamaño del archivo en bytes

                if (fileSize > {{ fsc.getMaxFileUpload() }} * 1024 * 1024) { // MB
                    e.preventDefault();
                    alert('{{ trans('backup-file-too-big', {'%size%': fsc.getMaxFileUpload()}) }}');
                    animateSpinner('remove');
                }
            });
        });
    </script>
{% endblock %}